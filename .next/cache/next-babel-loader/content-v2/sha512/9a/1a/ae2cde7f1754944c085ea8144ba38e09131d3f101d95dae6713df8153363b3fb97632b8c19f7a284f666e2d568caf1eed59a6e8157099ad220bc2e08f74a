{"ast":null,"code":"import { Fragment as _Fragment } from \"react/jsx-runtime\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nimport { jsxs as _jsxs } from \"react/jsx-runtime\";\nimport React, { useState, useEffect, useContext } from \"react\";\nimport Link from \"next/link\";\nimport Router, { useRouter } from \"next/router\";\nimport styles from \"../../../../../styles/pages/VisitPlanDetail.module.css\";\nimport { Stores } from \"../../../../../store\";\nimport Nav from \"../../../../../components/Nav\";\nimport Card from \"../../../../../components/Card\";\nimport Spinner from \"../../../../../components/Spinner\";\nimport Button from \"../../../../../components/Button\";\nimport { getPlanId, getUnplanNearMe, submitVisitPlan, submitVisitPlanDposm, getSearchJenisChannel } from \"../../../../../helper\";\nimport Modal from \"../../../../../components/Modal\";\nexport default function index() {\n  const {\n    state,\n    dispatch,\n    actions\n  } = useContext(Stores);\n  const {\n    0: loading,\n    1: setLoading\n  } = useState(true);\n  const {\n    0: loadingSubmit,\n    1: setLoadingSubmit\n  } = useState(false);\n  const {\n    0: searchJenisChannel,\n    1: setSearchJenisChannel\n  } = useState(\"\");\n  const {\n    0: renderListJenisChannel,\n    1: setRenderListJenisChannel\n  } = useState(false);\n  const {\n    0: listJenisChannel,\n    1: setListJenisChannel\n  } = useState([]);\n  const {\n    0: focusJenisChannel,\n    1: setFocusJenisChannel\n  } = useState({});\n  const {\n    0: plan,\n    1: setPlan\n  } = useState([]);\n  const {\n    0: visNotDone,\n    1: setVisNotDone\n  } = useState(false);\n  const router = useRouter();\n  var now = new Date();\n  useEffect(() => {\n    //   /GetAllMasterVisitPlan\"\n    if (router.query.id) {\n      getUnplanNearMe().then(res => {\n        var result = res.filter(val => {\n          return val.outletID === router.query.id;\n        });\n        console.log(result);\n        setPlan(result);\n        setLoading(false);\n      }).catch(err => {\n        console.log(err);\n      });\n    }\n  }, [router.query.id]);\n\n  const renderDetail = () => {\n    return /*#__PURE__*/_jsxs(\"div\", {\n      children: [renderDataDetail(\"Jenis Channel\", state.visitUnplanReducer.jenisChannel.namaJenisChannel), renderDataDetail(\"Outlet\", plan[0].namaOutlet), renderDataDetail(\"Alamat\", plan[0].alamatOutlet), renderDataDetail(\"Catatan\", state.visitUnplanReducer.catatan), renderDataDetail(\"Visibility\"), renderDataDetail(\"Avability\")]\n    });\n  };\n\n  const renderSearchJenisChannel = () => {\n    const render = listJenisChannel.map((val, index) => {\n      return /*#__PURE__*/_jsx(\"div\", {\n        onClick: () => {\n          setFocusJenisChannel(val);\n          actions.setUnplanJenisChannel(val);\n          setSearchJenisChannel(val.namaJenisChannel);\n          setListJenisChannel([]);\n        },\n        style: {\n          borderBottom: \".5px solid #f0f0f0\",\n          width: \"350px\"\n        },\n        children: val.namaJenisChannel\n      }, index);\n    });\n    return render;\n  };\n\n  const onSearchJenisChannel = search => {\n    setRenderListJenisChannel(true);\n    setSearchJenisChannel(search);\n\n    if (search) {\n      getSearchJenisChannel(search).then(data => {\n        setListJenisChannel(data);\n      }).catch(err => {\n        console.log(err);\n      });\n    } else {\n      setListJenisChannel([]);\n    }\n  };\n\n  const renderDataDetail = (type, data) => {\n    const doneFormVis = state.visitPlanReducer.visibility.filter(val => {\n      return val.file !== null && val.type !== null && val.brand !== null;\n    });\n    const doneFormAva = state.visitPlanReducer.avability;\n    return /*#__PURE__*/_jsxs(\"div\", {\n      children: [/*#__PURE__*/_jsxs(\"div\", {\n        className: styles.render_data,\n        children: [type, /*#__PURE__*/_jsx(\"div\", {\n          style: {\n            textAlign: \"right\"\n          },\n          children: type === \"Visibility\" ? `${doneFormVis.length}/6` : type === \"Avability\" ? `${doneFormAva.length}/25` : \"\"\n        })]\n      }), type === \"Jenis Channel\" ? /*#__PURE__*/_jsxs(_Fragment, {\n        children: [/*#__PURE__*/_jsx(\"input\", {\n          onChange: e => {\n            onSearchJenisChannel(e.target.value);\n          },\n          value: state.visitUnplanReducer.jenisChannel.namaJenisChannel ? state.visitUnplanReducer.jenisChannel.namaJenisChannel : searchJenisChannel,\n          placeholder: \"Search\",\n          className: styles.input,\n          onBlur: () => {\n            setTimeout(() => {\n              setRenderListJenisChannel(false);\n            }, 200);\n          },\n          onFocus: e => onSearchJenisChannel(e.target.value)\n        }), renderListJenisChannel ? /*#__PURE__*/_jsx(\"div\", {\n          style: {\n            position: \"absolute\",\n            maxHeight: \"180px\",\n            backgroundColor: \"white\",\n            overflowY: \"scroll\",\n            maxWidth: \"400px\",\n            padding: \"0 4px\",\n            zIndex: 999999,\n            marginTop: \"-10px\"\n          },\n          children: renderSearchJenisChannel()\n        }) : null]\n      }) : type === \"Outlet\" ? /*#__PURE__*/_jsx(Card, {\n        style: {\n          marginTop: \"6px\",\n          borderRadius: \"5px\"\n        },\n        children: /*#__PURE__*/_jsx(\"div\", {\n          className: styles.render_value,\n          children: data\n        })\n      }) : type === \"Alamat\" ? /*#__PURE__*/_jsx(Card, {\n        style: {\n          marginTop: \"6px\",\n          borderRadius: \"5px\"\n        },\n        children: /*#__PURE__*/_jsx(\"div\", {\n          className: styles.render_value,\n          children: data\n        })\n      }) : type === \"Catatan\" ? /*#__PURE__*/_jsx(Card, {\n        style: {\n          marginTop: \"6px\",\n          borderRadius: \"5px\"\n        },\n        children: /*#__PURE__*/_jsx(\"div\", {\n          className: styles.render_value,\n          children: /*#__PURE__*/_jsx(\"textarea\", {\n            style: {\n              width: \"100%\",\n              border: \"none\",\n              height: \"70px\"\n            },\n            onChange: e => {\n              actions.setUnplanCatatan(e.target.value);\n            },\n            value: state.visitUnplanReducer.catatan\n          })\n        })\n      }) : type === \"Visibility\" || type === \"Avability\" ? /*#__PURE__*/_jsx(Card, {\n        style: {\n          marginTop: \"6px\",\n          borderRadius: \"5px\"\n        },\n        children: /*#__PURE__*/_jsxs(\"div\", {\n          className: styles.render_value,\n          children: [/*#__PURE__*/_jsx(\"div\", {\n            children: type === \"Visibility\" ? /*#__PURE__*/_jsxs(\"div\", {\n              children: [/*#__PURE__*/_jsx(\"div\", {\n                className: styles.progress_bar\n              }), /*#__PURE__*/_jsx(\"div\", {\n                className: styles.progress_bar_now,\n                style: {\n                  width: `${doneFormVis.length / 6 * 100}%`\n                }\n              })]\n            }) : type === \"Avability\" ? /*#__PURE__*/_jsxs(\"div\", {\n              children: [/*#__PURE__*/_jsx(\"div\", {\n                className: styles.progress_bar\n              }), /*#__PURE__*/_jsx(\"div\", {\n                className: styles.progress_bar_now,\n                style: {\n                  width: `${doneFormAva.length / 25 * 100}%`\n                }\n              })]\n            }) : \"\"\n          }), type === \"Avability\" ? state.visitUnplanReducer.jenisChannel.namaJenisChannel ? /*#__PURE__*/_jsx(Link, {\n            href: `/visit/unplan/nearme/${plan[0].outletID}/avability`,\n            children: /*#__PURE__*/_jsx(\"a\", {\n              children: /*#__PURE__*/_jsx(Button, {\n                text: \"Add\"\n              })\n            })\n          }) : /*#__PURE__*/_jsx(Button, {\n            text: \"Add\"\n          }) : type === \"Visibility\" ? state.visitUnplanReducer.jenisChannel.namaJenisChannel ? /*#__PURE__*/_jsx(Link, {\n            href: `/visit/unplan/nearme/${plan[0].outletID}/visibility`,\n            children: /*#__PURE__*/_jsx(\"a\", {\n              children: /*#__PURE__*/_jsx(Button, {\n                text: \"Add\"\n              })\n            })\n          }) : /*#__PURE__*/_jsx(Button, {\n            text: \"Add\"\n          }) : null]\n        })\n      }) : /*#__PURE__*/_jsx(Card, {\n        style: {\n          marginTop: \"6px\",\n          borderRadius: \"5px\"\n        },\n        children: /*#__PURE__*/_jsx(\"div\", {\n          className: styles.render_value,\n          children: /*#__PURE__*/_jsx(_Fragment, {\n            children: data\n          })\n        })\n      })]\n    });\n  };\n\n  const onSubmit = () => {\n    const visDone = state.visitPlanReducer.visibility.filter(val => {\n      return val.file !== null && val.type !== null && val.brand !== null;\n    }); // console.log(state.visitPlanReducer.visibility);\n\n    if (visDone.length === 6) {\n      setLoadingSubmit(true);\n      setVisNotDone(false);\n      const userData = JSON.parse(localStorage.getItem(\"user\"));\n      const bodyPlan = {\n        id: plan.id,\n        idMasterPlanVisit: plan.id,\n        nomorDokumen: plan.nomorDokumen,\n        catatan: state.visitPlanReducer.catatan,\n        isCheckIn: true,\n        checkInDate: state.visitPlanReducer.checkIn.toISOString(),\n        isCheckOut: true,\n        checkOutDate: now.toISOString(),\n        createdBy: userData.username,\n        updatedBy: userData.username\n      };\n      const files = state.visitPlanReducer.visibility.map((val, index) => {\n        return val.file;\n      });\n      const bodyProduct = state.visitPlanReducer.avability.map((val, index) => {\n        return {\n          // id: val.productFocus.produkID,\n          id: plan.id,\n          activityVisitPlanId: plan.id,\n          nomorDokumen: plan.nomorDokumen,\n          nomor: index,\n          kodeProduk: val.productFocus.produkID,\n          namaProduk: val.productFocus.namaProduk,\n          stok: parseInt(val.stock),\n          saranOrder: parseInt(val.saranOrder),\n          jumlahOrder: parseInt(val.order),\n          createdBy: userData.username,\n          updatedBy: userData.username,\n          harga: parseInt(val.harga),\n          total: parseInt(val.harga) * parseInt(val.order),\n          keterangan: val.ket\n        };\n      });\n      var data = {\n        avp: bodyPlan,\n        dProductList: bodyProduct\n      };\n      submitVisitPlan(data).then(res => {\n        // console.log(\"ini res\", res);\n        const bodyPosm = state.visitPlanReducer.visibility.map((val, index) => {\n          return {\n            id: plan.id,\n            activityVisitPlanId: res.avp.id,\n            nomorDokumen: plan.nomorDokumen,\n            nomor: index,\n            tipe: val.type.program,\n            namaFile: val.file.name,\n            createdBy: userData.username,\n            updatedBy: userData.username\n          };\n        });\n\n        for (let i = 0; i < files.length; i++) {\n          submitVisitPlanDposm(bodyPosm[i], files[i]).then(res => {\n            if (i === 7) {\n              setLoadingSubmit(false);\n              Router.push(\"/\");\n              actions.setDefaultVisitPlan();\n            }\n          }).catch(err => {\n            console.log(err);\n          });\n        }\n      }).catch(err => {\n        console.log(err);\n      });\n    } else {\n      setVisNotDone(true);\n    }\n  };\n\n  const render = () => {\n    const visDone = state.visitUnplanReducer.visibility.filter(val => {\n      return val.file !== null && val.type !== null && val.brand !== null;\n    });\n\n    if (loading) {\n      return /*#__PURE__*/_jsx(Spinner, {});\n    } else {\n      return /*#__PURE__*/_jsx(_Fragment, {\n        children: /*#__PURE__*/_jsxs(\"div\", {\n          className: styles.container,\n          children: [loadingSubmit ? /*#__PURE__*/_jsx(Modal, {\n            children: /*#__PURE__*/_jsx(Spinner, {})\n          }) : null, /*#__PURE__*/_jsxs(\"div\", {\n            className: styles.wrapper,\n            children: [/*#__PURE__*/_jsx(Nav, {\n              title: \"Near Me\",\n              color: \"white\",\n              action: \"Submit\",\n              onClick: () => {\n                onSubmit();\n              },\n              disable: visDone.length === 6 ? false : true,\n              backAction: () => {\n                if (confirm(\"Data will be lost if you leave the page, are you sure?\")) {\n                  actions.setDefaultVisitUnplan();\n                  Router.push(\"/visit/unplan/nearme\");\n                }\n              }\n            }), /*#__PURE__*/_jsxs(\"div\", {\n              className: styles.main,\n              children: [visNotDone ? /*#__PURE__*/_jsx(\"div\", {\n                style: {\n                  color: \"red\",\n                  fontSize: \"13px\",\n                  textAlign: \"center\"\n                },\n                children: \"Please complete visibility data\"\n              }) : \"\", renderDetail()]\n            })]\n          })]\n        })\n      });\n    }\n  };\n\n  return render();\n}","map":null,"metadata":{},"sourceType":"module"}